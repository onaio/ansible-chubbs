---
- name: Install Node.js Packages
  become: true
  become_user: "{{ chubbs_system_user }}"
  npm:
    global: yes
    name: pm2
    executable: "{{ chubbs_nvm_npm_path }}"
    version: "{{ chubbs_nvm_pm2_version }}"
  environment:
    PATH: "{{ chubbs_nvm_node_dir }}/bin:{{ ansible_env.PATH }}"

- name: delete specific pm2 process
  become: true
  become_user: "{{ chubbs_system_user }}"
  command: "{{ chubbs_nvm_pm2_path }} delete {{ chubbs_service_name }}"
  # this shell fails if the process has not yet been started
  register: delete_result
  changed_when:
    - "'âœ“' in delete_result.stdout"
    - delete_result.rc == 0
  failed_when:
    - "'Process or Namespace {{ chubbs_service_name }} not found' not in delete_result.stdout"
    - delete_result.rc != 0
  environment:
    PATH: "{{ chubbs_nvm_node_dir }}/bin:{{ ansible_env.PATH }}"
    HOME: "{{ chubbs_system_user_home }}"
  notify:
    - "reload pm2"

- name: start pm2 app
  become: true
  become_user: "{{ chubbs_system_user }}"
  command: "{{ chubbs_nvm_pm2_path }} start app.js -i 0 -n {{ chubbs_service_name }}"
  register: start_result
  changed_when:
    - "'Done.' in start_result.stdout"
    - start_result.rc == 0
  failed_when:
    - "'ERROR' in start_result.stdout"
    - start_result.rc != 0
  args:
    chdir: "{{ chubbs_codebase_path }}"
  environment:
    PATH: "{{ chubbs_nvm_node_dir }}/bin:{{ ansible_env.PATH }}"
    HOME: "{{ chubbs_system_user_home }}"
  notify:
    - "reload pm2"

- name: save the current PM2 running list
  become: true
  become_user: "{{ chubbs_system_user }}"
  command: "{{ chubbs_nvm_pm2_path }} save"
  register: save_result
  changed_when:
    - "'Successfully saved' in save_result.stdout"
  failed_when:
    - save_result.rc != 0
  environment:
    PATH: "{{ chubbs_nvm_node_dir }}/bin:{{ ansible_env.PATH }}"
    HOME: "{{ chubbs_system_user_home }}"
  notify:
    - "reload pm2"

- name: delete the old startup file
  command: "{{ chubbs_nvm_pm2_path }} unstartup {{ chubbs_init_system }} -u {{ chubbs_system_user }}"
  register: unstartup_result
  changed_when:
    - "'Init file disabled.' in unstartup_result.stdout"
  failed_when:
    - "'Failed' in unstartup_result.stdout"
  environment:
    PATH: "{{ chubbs_nvm_node_dir }}/bin:{{ ansible_env.PATH }}"
  ignore_errors: yes
  notify:
    - "reload pm2"

- name: generate an PM2 init service file
  command: "{{ chubbs_nvm_pm2_path }} startup {{ chubbs_init_system }} -u {{ chubbs_system_user }} --hp {{ chubbs_system_user_home }}"
  environment:
    PATH: "{{ chubbs_nvm_node_dir }}/bin:{{ ansible_env.PATH }}"
  register: startup_result
  changed_when:
    - "'Command successfully executed.' in startup_result.stdout"
  failed_when:
    -
  notify:
    - "reload pm2"

- name: Enable the PM2 service
  service:
    name: "pm2-{{ chubbs_service_name }}"
    enabled: yes
